<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rhsnc.ovpe.mapper.VhclAnlsMapper">
    
    <!-- 등록정보 조회 -->
    <select id="selectVhclInfo" parameterType="String" resultType="CegCarMig">
        SELECT
            *
        FROM CEG_CAR_MIG
        WHERE VHRNO = #{carRegNo}
    </select>

    <!-- 검사정보 목록 조회 -->
    <select id="selectInspInfoList" parameterType="String" resultType="TbEetHisMe">
        SELECT
            *
        FROM TB_EET_HIS_ME
        WHERE CAR_REG_NO = #{carRegNo}
        ORDER BY SMO_CHK_DATE DESC
    </select>

    <select id="selectAnlsInfo" parameterType="map" resultType="TbAnlsMe">
        SELECT #{vtxt} AS ITEM_NM, CONCAT(LIM, ', ', GROUP_CONCAT(CONCAT('(', VAL, ',', CNT, ')') ORDER BY VAL SEPARATOR ', ')) AS VALSET
        FROM (
            SELECT VNM, VFUL, ENGT, VMY, CHKM, VTAG, LIM, ABS(VAL) AS VAL, SUM(CNT) AS CNT FROM TB_ANLS_ME
            WHERE CHKM = #{chkm}
            AND VNM = #{vnm} AND VFUL = #{vful} AND ENGT = #{engt} AND VMY = #{vmy}
            AND VTAG = #{vtag} AND LIM = #{limVal}
            GROUP BY VNM, VFUL, ENGT, VMY, CHKM, VTAG, LIM, ABS(VAL)
        ) AA
        GROUP BY LIM
    </select>
</mapper> 